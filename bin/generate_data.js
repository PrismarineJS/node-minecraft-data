#!/usr/bin/env node

const dataSource = require('../minecraft-data/data/dataPaths')
const fs = require('fs')
const path = require('path')

const INLINE_LIMIT = 1024

/*
// Used as reference function
//
function generateMap () {
  let data = '{\n'
  for (const platform in dataSource) {
    data += `  ${platform}: {\n`
    const platformData = dataSource[platform]
    for (const version in platformData) {
      data += `    "${version}": {\n`
      const versionData = platformData[version]
      for (const file in versionData) {
        const filePath = `./minecraft-data/data/${versionData[file]}/${file}.json`
        const relPath = path.join(__dirname, '.' + filePath)
        if (fs.statSync(relPath).size > INLINE_LIMIT) {
          data += `      ${file}: require("${filePath}"),\n`
        } else {
          data += `      ${file}: ${JSON.stringify(require(relPath))},\n`
        }
      }
      data += '    },\n'
    }
    data += '  },\n'
  }
  data += '}\n'
  return data
}
*/

function generateSwitchMap () {
  let data = '{\n'
  for (const platform in dataSource) {
    const platformData = dataSource[platform]
    const versions = Object.keys(platformData).map(v => `"${v}":0`).join()
    data += `  ${platform}: new Proxy({${versions}}, {\n    get (target, prop) {\n      switch (prop) {\n`    
    for (const version in platformData) {
      data += `        case "${version}": return {\n`
      const versionData = platformData[version]
      for (const file in versionData) {
        const filePath = `./minecraft-data/data/${versionData[file]}/${file}.json`
        const relPath = path.join(__dirname, '.' + filePath)
        if (fs.statSync(relPath).size > INLINE_LIMIT) {
          data += `          ${file}: require("${filePath}"),\n`
        } else {
          data += `          ${file}: ${JSON.stringify(require(relPath))},\n`
        }
      }
      data += '        }\n'
    }
    data += '      }\n    }\n  }),\n'
  }
  data += '}\n'
  return data
}

const data = `// DO NOT EDIT: THIS FILE IS AUTOGENERATED
// PLEASE RUN ./bin/generate_data.js INSTEAD
//
module.exports = ${generateSwitchMap()}
`

fs.writeFileSync(path.join(__dirname, '/../data.js'), data)
